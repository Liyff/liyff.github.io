# epoll

### select缺陷

- fd_set的本质是一个位图，容量固定1024
- 监听和就绪用的是同一个数据结构



![image-20250630180912892](C:\Users\LIYUFENG\AppData\Roaming\Typora\typora-user-images\image-20250630180912892.png)

## epoll

- 高并发服务器的基石 epoll


- 是一种高性能的**IO多路复用**

![image-20250630182309446](C:\Users\LIYUFENG\AppData\Roaming\Typora\typora-user-images\image-20250630182309446.png)

![image-20250701152845433](C:\Users\LIYUFENG\AppData\Roaming\Typora\typora-user-images\image-20250701152845433.png)

#include <sys/epoll.h>

### 创建文件对象

- int epfd = epoll_create(1);
- 

### 设置监听

- epoll_ctl

![image-20250701153938749](C:\Users\LIYUFENG\AppData\Roaming\Typora\typora-user-images\image-20250701153938749.png)

### 陷入阻塞

![image-20250701154326435](C:\Users\LIYUFENG\AppData\Roaming\Typora\typora-user-images\image-20250701154326435.png)

![image-20250701160851650](C:\Users\LIYUFENG\AppData\Roaming\Typora\typora-user-images\image-20250701160851650.png)

![image-20250701160930697](C:\Users\LIYUFENG\AppData\Roaming\Typora\typora-user-images\image-20250701160930697.png)

### 使用epoll支持超时断线/重连



![image-20250701164636995](C:\Users\LIYUFENG\AppData\Roaming\Typora\typora-user-images\image-20250701164636995.png)

![image-20250701164552280](C:\Users\LIYUFENG\AppData\Roaming\Typora\typora-user-images\image-20250701164552280.png)

![image-20250701164341477](C:\Users\LIYUFENG\AppData\Roaming\Typora\typora-user-images\image-20250701164341477.png)

### recv和read的非阻塞

![image-20250701170029019](C:\Users\LIYUFENG\AppData\Roaming\Typora\typora-user-images\image-20250701170029019.png)

#### fcntl

- 设置文件描述符非阻塞

![image-20250701172937574](C:\Users\LIYUFENG\AppData\Roaming\Typora\typora-user-images\image-20250701172937574.png)

#### 另一种方法非阻塞

![image-20250701173335981](C:\Users\LIYUFENG\AppData\Roaming\Typora\typora-user-images\image-20250701173335981.png)



### epoll触发方式

![image-20250701174733333](C:\Users\LIYUFENG\AppData\Roaming\Typora\typora-user-images\image-20250701174733333.png)

##### 边缘触发

- 减少就绪次数

![image-20250701175840277](C:\Users\LIYUFENG\AppData\Roaming\Typora\typora-user-images\image-20250701175840277.png)



## 设置socket的属性

![image-20250701182844898](C:\Users\LIYUFENG\AppData\Roaming\Typora\typora-user-images\image-20250701182844898.png)



#### 缓冲区下限

![image-20250701183614662](C:\Users\LIYUFENG\AppData\Roaming\Typora\typora-user-images\image-20250701183614662.png)

#### recv MSG_PEEK属性

- 先复制不取出

![image-20250701184231563](C:\Users\LIYUFENG\AppData\Roaming\Typora\typora-user-images\image-20250701184231563.png)